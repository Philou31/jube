<?xml version="1.0" encoding="UTF-8"?>
<jube>
    <!-- Default JURECA sets -->
    <parameterset name="executeset">
        <!-- Jobscript handling -->
        <parameter name="submit">sbatch</parameter>
        <parameter name="submit_script">submit.job</parameter>
        <parameter name="done_file">ready</parameter>
<!--        <parameter name="starter">mpirun  -binding "pin=enable;domain=socket;order=scatter" -genv KMP_PLACES=1T</parameter> -->
        <parameter name="starter">mpirun</parameter>
        <parameter name="args_starter"></parameter>
        <!-- Chainjob handling -->
        <parameter name="shared_folder">shared</parameter>
        <parameter name="shared_job_info">${shared_folder}/jobid</parameter>
        <parameter name="chainjob_script">./jureca-chainJobs.sh</parameter>
        <parameter name="chainjob_needs_submit">false</parameter>
    </parameterset>

    <parameterset name="systemParameter">
        <!-- Default jobscript parameter  -->
        <parameter name="nodes" type="int">1</parameter>
        <parameter name="taskspernode" type="int">1</parameter>
        <parameter name="threadspertask" type="int">1</parameter>
        <parameter name="tasks" mode="python" type="int">
            $nodes * $taskspernode
        </parameter>
        <parameter name="OMP_NUM_THREADS" type="int" export="true">
            $threadspertask
        </parameter>
        <parameter name="queue">prod</parameter>
        <parameter name="executable"></parameter>
        <parameter name="args_exec"></parameter>
        <parameter name="mail">leleux@cerfacs.fr</parameter>
        <parameter name="env" separator=";">$jube_wp_envstr</parameter>
        <parameter name="extended_env">
           ${module_list}
           export FORT_BUFFERED=$use_buffered_io
	   export OMP_NUM_THREADS=$threadspertask
	   export MKL_NUM_THREADS=$threadspertask
        </parameter>
        <parameter name="env" mode="python" separator=";">
        {"darshan": """
                ${extended_env}
                module load darshan-runtime
		export LD_PRELOAD=$$EBROOTDARSHANMINRUNTIME/lib/libdarshan.so
		export DARSHAN_LOG_PATH=$$PWD
		export DARSHAN_LOGFILE=darshan.log
                   """,
         "papi": """
                ${extended_env}
		module load perf/scalasca/2.2.1
                export SCOREP_TOTAL_MEMORY=350MB
                export SCOREP_MPI_MAX_COMMUNICATORS=5000
<!--                export SCOREP_METRIC_PAPI_PER_PROCESS=PAPI_TOT_INS,PAPI_TOT_CYC,PAPI_L3_TCA,PAPI_L3_TCM -->
                export SCOREP_METRIC_PAPI=PAPI_TOT_INS,PAPI_TOT_CYC,PAPI_L3_TCA,PAPI_L3_TCM
                   """,
         "scalasca": """
                ${extended_env}
                module load perf/scalasca/2.2.1
                unset SCAN_TRACE_FILESYS
                export SCOREP_TOTAL_MEMORY=350MB
                export SCOREP_MPI_MAX_COMMUNICATORS=5000
                export SCAN_ANALYZE_OPTS=--single-pass
                   """}.get("${mode}","""${extended_env}""")
        </parameter>
        <parameter name="notification">ALL</parameter>
        <parameter name="outlogfile">job.out</parameter>
        <parameter name="errlogfile">job.err</parameter>
        <parameter name="timelimit">12:00:00</parameter>
        <parameter name="preprocess"></parameter>
        <parameter name="postprocess"></parameter>
        <parameter name="measurement"></parameter>
    </parameterset>

    <substituteset name="executesub">
        <!-- Default jobscript substitution -->
        <iofile in="${submit_script}.in" out="$submit_script" />
        <sub source="#ENV#" dest="$env" />
        <sub source="#NOTIFY_EMAIL#" dest="$mail" />
        <sub source="#NOTIFICATION_TYPE#" dest="$notification" />
        <sub source="#BENCHNAME#"
             dest="${jube_benchmark_name}_${jube_step_name}_${jube_wp_id}" />
        <sub source="#NODES#" dest="$nodes" />
        <sub source="#TASKS#" dest="$tasks" />
        <sub source="#NCPUS#" dest="$taskspernode" />
        <sub source="#NTHREADS#" dest="$threadspertask" />
        <sub source="#TIME_LIMIT#" dest="$timelimit" />
        <sub source="#PREPROCESS#" dest="$preprocess" />
        <sub source="#POSTPROCESS#" dest="$postprocess" />
        <sub source="#QUEUE#" dest="$queue" />
        <sub source="#STARTER#" dest="$starter" />
        <sub source="#ARGS_STARTER#" dest="$args_starter" />
        <sub source="#MEASUREMENT#" dest="$measurement" />
        <sub source="#STDOUTLOGFILE#" dest="$outlogfile" />
        <sub source="#STDERRLOGFILE#" dest="$errlogfile" />
        <sub source="#EXECUTABLE#" dest="$executable" />
        <sub source="#ARGS_EXECUTABLE#" dest="$args_exec" />
        <sub source="#FLAG#" dest="touch $done_file" />
    </substituteset>

    <substituteset name="chainsub">
        <!-- Default chainjob substitution -->
    </substituteset>

    <fileset name="jobfiles">
        <!-- Default jobscript access -->
        <copy>${submit_script}.in</copy>
    </fileset>

    <fileset name="chainfiles">
        <!-- Chainjob script access -->
        <copy>$chainjob_script</copy>
    </fileset>
</jube>
